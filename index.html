<!DOCTYPE html>
<html>
<head lang="en">
    <meta charset="UTF-8">
    <title>SOROKIN</title>
    <script src="jquery-2.1.1.min.js"></script>
    <script src="d3.min.js"></script>
    <style>

        .node circle {
            fill: #fff;
            stroke: steelblue;
            stroke-width: 1.5px;
        }

        .node {
            font: 10px sans-serif;
        }

        .link {
            fill: none;
            stroke: #ccc;
            stroke-width: 1.5px;
        }

    </style>
</head>
<body>
<input type="text" id="text" alt="op" size="40" autofocus=""/>
<input type="button" onclick="tree()" value="ѕострить дерево выражени€"/>
<script>
    treeData=[];
    function tree(){

        var t=document.getElementById("text").value;
        var OPN=poliz(t);
        create_tree(OPN);
        Draw();

    }
function poliz(t){

    var res=[];
    var stack=[];

    for (var i=0;i< t.length;i++) {
        if (isv(t[i])==1)
            res.push(t[i]);
        else if (t[i] == '(')
            res.push(t[i]);
        else if (t[i] == ')') {
            while (stack[stack.length - 1] != '(') {
                res.push(stack.pop());
                if (stack.length == 1 && stack[0] != '(')
                    return "error";
            }
            stack.pop();
        }
        else if (prior(t[i]) >= 0) {
            if(stack.length!=0){
            while (prior(t[i]) <= prior(stack[stack.length - 1]))
                res.push(stack.pop());}

            stack.push(t[i]);
        }
    }
        for(var i=0;i<stack.length;i++)
        {
            if(prior(stack[i])<0)
                return "error_brackets";
        }

        while(stack.length!=0)
        {
            res.push(stack.pop());
        }

        return res;

    }


    function prior(c){
        if((c=='+')||(c=='-'))
            return 0;
        else if((c=='*')||(c=='/'))
            return 1;
        else if(c=='^')
            return 2;
        else
            return -1;
    }

    function isv(c) {

        if (((c >= 'A') && (c <= 'Z')) || ((c >= 'a') && (c <= 'z')))
            return 1;

        else
            return 0;

    }

function create_tree(OPN)
{

    var stack = [];
    for(var i = 0; i<OPN.length; i++){
        var element = OPN[i];
        if((element=='+')||(element=='-')||(element=='*')||(element=='/')||(element=='^')){//проверка на оператор
            var second = stack.pop();
            var first = stack.pop();
            var node = {"name": element, "children": [first, second]};
            stack.push(node);
        }
        else {
            var node = {"name": element, "children": []};
            stack.push(node);
        }
    }
    treeData[0]=stack[0];

}

    function Draw() {
        // ************** Generate the tree diagram	 *****************
        var margin = {
                    top: 100,
                    right: 100,
                    bottom: 5,
                    left: 100
                },
                width = $(window).width()*3/4 - margin.right - margin.left,
                height = $(window).height() - margin.top - margin.bottom;

        var i = 0;

        var tree = d3.layout.tree()
                .size([height, width]);

        var diagonal = d3.svg.diagonal()
                .projection(function(d) {
                    return [d.x, d.y];
                });

        var svg = d3.select("body").append("svg")
                .attr("width", width + margin.right + margin.left)
                .attr("height", height + margin.top + margin.bottom)
                .append("g")
                .attr("transform", "translate(" + margin.left + "," + margin.top + ")");

        root = treeData[0];

        update(root);

        function update(source) {

            // Compute the new tree layout.
            var nodes = tree.nodes(root).reverse(),
                    links = tree.links(nodes);

            // Normalize for fixed-depth.
            nodes.forEach(function(d) {
                d.y = d.depth * 100;
            });

            // Declare the nodes?
            var node = svg.selectAll("g.node")
                    .data(nodes, function(d) {
                        return d.id || (d.id = ++i);
                    });

            // Enter the nodes.
            var nodeEnter = node.enter().append("g")
                    .attr("class", "node")
                    .attr("transform", function(d) {
                        return "translate(" + d.x + "," + d.y + ")";
                    });

            nodeEnter.append("circle")
                    .attr("r", 22)
                    .style("fill", "#fff");

            nodeEnter.append("text")
                //	  .attr("y", function(d) {
                //		  return d.children || d._children ? -18 : 18; })
                    .attr("dy", ".35em")
                    .attr("text-anchor", "middle")
                    .text(function(d) {
                        return d.name;
                    })
                    .style("fill-opacity", 1);

            nodeEnter.append("text")
                    .attr("y", function(d) {
                        return d.children || d._children ? -30 : 0; })
                    .attr("x", function(d) {
                        return d.children || d._children ? 30 : 0; })
                    .attr("dy", ".35em")
                    .attr("text-anchor", "middle")
                    .text(function(d) {
                        return d.children || d._children ? d.value : "";
                    })
                    .style("font-size", "17px")
                    .style("fill", "#777");

            // Declare the links?
            var link = svg.selectAll("path.link")
                    .data(links, function(d) {
                        return d.target.id;
                    });

            // Enter the links.
            link.enter().insert("path", "g")
                    .attr("class", "link")
                    .attr("d", diagonal);

        }
    }


</script>

</body>
</html>